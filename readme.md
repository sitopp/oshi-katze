
# 推し活エージェント

## 概要

https://zenn.dev/voicehackerjp/articles/818266fd2510e5

## 構成図

<img src="https://storage.googleapis.com/zenn-user-upload/58bc1f2c9d16-20250210.jpg">


## 各プロセス　

### 1. メイン処理

名前：ai-agent-service

仕様：

ユーザーとの会話を司る。

'ユーザー登録の場合は「1」を、\nすでに登録済みで推しの最新情報ゲットの場合は「2」を入力してください。'

「1」：登録フォームへのリンクを返答

「2」：

　　・ユーザー登録済みの場合、'知りたい情報の番号を入力してください。\n21:物販情報\n22:イベント（ライブ・ファンミーティング）\n23:出演（TV・ラジオ）\n24:雑誌関連情報\n25:写真集'
  
　　・ユーザー未登録の場合「推しの登録がありません。登録するには、「1」を返信してください。」　

「21」〜「24」：Firestoreからデータを取得して表示

使い方：

cloud Run にデプロイして、払い出されたエンドポイントをLINE Messaging APIからWebhookで呼び出す。


### 2. 登録フォーム

名前："register-form"

仕様：
ユーザー登録。

・Google スプレッドシートのタレントマスタから、タレント一覧を取得して表示。

・ユーザー入力内容をユーザーテーブルに追加。
　
使い方：
cloud Run にデプロイして、払い出されたエンドポイントをai-agent-serviceから指定する。（envファイルに書く）


### 3. バッチ処理

名前："aiagent-scheduler"

仕様：
タレントマスタを読み込み、1タレントx1カテゴリごとにDifyの調査エージェントを呼び出す

使い方：
cloud Run にデプロイして、Cloud Schedulerから1日1回呼び出す。



### 4. Dify 処理

AIエージェント処理のキモ。

仕様：
URLを受け取り、スクレイピングして要約し、リクエスト結果をCloud Runの"firestore-writer"に送信する

バッチ前提だが、1から呼ばれる場合もあるので、LINE ReplyTokenを受け取っていた場合は、LINEに内容を送信する⭐︎

※処理が輻輳化してしまうと動かなくなってしまうので、いずれはCloud Runに焼き直す⭐︎
　


### 5. バッチの続き、書き込み処理

名前："firestore-writer"

仕様：
受け取った内容にtimestampを添えてFirestoreに書き出す

使い方：
cloud Run にデプロイして、払い出されたエンドポイントURLをDifyのワークフロー内から指定する。

